<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Helios OS — AI Cloud Desktop</title>
  <style>
    :root{
      --bg:#071428;
      --card:#0b1220;
      --muted:#94a3b8;
      --accent:#7c3aed;
      --accent-light:#9061f9;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --info:#3b82f6;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#061021,#07162a);color:#e6eef8}
    .app{display:grid;grid-template-columns:1fr 420px;height:100vh;gap:12px;padding:12px;box-sizing:border-box}
    .viewer{background:var(--card);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    .viewer-header{display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#4f46e5);display:flex;align-items:center;justify-content:center;font-weight:700}
    .viewer-iframe{flex:1;background:#000}
    iframe{width:100%;height:100%;border:0;display:block}
    .assistant{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    header.assist-top{display:flex;align-items:center;justify-content:space-between}
    .meta{color:var(--muted);font-size:13px}
    .chat{flex:1;overflow:auto;padding-right:6px}
    .msg{margin:8px 0;display:flex}
    .msg.user{justify-content:flex-end}
    .bubble{max-width:85%;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
    .msg.user .bubble{background:linear-gradient(180deg,#0b1220,#07102a);border:1px solid rgba(124,58,237,0.22)}
    .controls{display:flex;gap:8px;align-items:center}
    textarea.input{width:100%;min-height:64px;max-height:160px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;resize:vertical}
    button.primary{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.primary:hover{background:var(--accent-light)}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
    button.ghost:hover{background:rgba(255,255,255,0.03);color:#fff}
    .small{font-size:12px;color:var(--muted)}
    .panel{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:10px}
    .cmd-out{white-space:pre-wrap;background:#031021;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);max-height:160px;overflow:auto}
    .footer{border-top:1px solid rgba(255,255,255,0.02);padding-top:8px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between}
    
    /* Tabs */
    .tabs{display:flex;border-bottom:1px solid rgba(255,255,255,0.05);margin-bottom:10px}
    .tab{padding:8px 12px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent}
    .tab.active{color:#fff;border-bottom:2px solid var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    /* File Explorer */
    .file-explorer{height:300px;overflow:auto;background:#031021;border-radius:6px;border:1px solid rgba(255,255,255,0.02)}
    .file-path{padding:8px;background:rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between}
    .file-list{list-style:none;padding:0;margin:0}
    .file-item{padding:6px 8px;display:flex;align-items:center;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.01)}
    .file-item:hover{background:rgba(255,255,255,0.02)}
    .file-icon{margin-right:8px;width:16px;text-align:center}
    .file-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .file-size{font-size:11px;color:var(--muted);margin-left:8px}
    
    /* App Launcher */
    .app-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:10px}
    .app-item{display:flex;flex-direction:column;align-items:center;padding:10px;border-radius:8px;cursor:pointer;text-align:center}
    .app-item:hover{background:rgba(255,255,255,0.02)}
    .app-icon{width:48px;height:48px;border-radius:8px;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;margin-bottom:8px;font-size:24px}
    .app-name{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    
    /* System Monitor */
    .system-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat-card{background:rgba(255,255,255,0.02);border-radius:8px;padding:10px;display:flex;flex-direction:column}
    .stat-title{font-size:12px;color:var(--muted);margin-bottom:4px}
    .stat-value{font-size:18px;font-weight:600}
    .stat-meta{font-size:11px;color:var(--muted);margin-top:4px}
    
    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:var(--card);border-radius:12px;width:90%;max-width:600px;max-height:80vh;overflow:auto;box-shadow:0 10px 25px rgba(0,0,0,0.5)}
    .modal-header{padding:15px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:15px}
    .modal-footer{padding:15px;border-top:1px solid rgba(255,255,255,0.05);display:flex;justify-content:flex-end;gap:10px}
    .close-modal{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
    
    @media (max-width:900px){.app{grid-template-columns:1fr;grid-auto-rows:1fr 420px}}
  </style>
</head>
<body>
  <div class="app">
    <div class="viewer">
      <div class="viewer-header">
        <div class="brand">
          <div class="logo">L</div>
          <div>
            <div style="font-weight:600">Aurora OS — Leo</div>
            <div class="small">Fluxbox + Xvfb streamed via noVNC</div>
          </div>
        </div>
        <div style="margin-left:auto" class="small">
          <a class="ghost" href="/vnc.html" target="_blank" style="text-decoration:none;color:inherit;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03)">Open raw VNC</a>
          <a class="ghost" href="/docs" target="_blank" style="text-decoration:none;color:inherit;padding:6px;border-radius:6px;margin-left:8px;border:1px solid rgba(255,255,255,0.03)">API Docs</a>
        </div>
      </div>
      <div class="viewer-iframe">
        <!-- iframe the original vnc.html -->
        <iframe id="novnc" src="/vnc.html" title="Aurora Desktop"></iframe>
      </div>
    </div>

    <aside class="assistant" role="complementary">
      <header class="assist-top">
        <div>
          <div style="font-weight:700">Leo — your OS assistant</div>
          <div class="meta">Helpful AI for the Aurora OS (local POC)</div>
        </div>
        <div class="small">Status: <span id="status">connecting…</span></div>
      </header>

      <div class="chat" id="chat">
        <div class="msg ai"><div class="bubble">Hi — I'm Leo. I’m here to help you use the desktop and get things done. Try: <strong>Summarize: &lt;text&gt;</strong> or run a safe command from 'Run Command'.</div></div>
      </div>

      <div>
        <textarea id="input" class="input" placeholder="Ask Leo to summarize text, run diagnostics, or explain how to do things..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button id="send" class="primary">Send</button>
          <button id="summarize" class="ghost">Summarize</button>
          <div style="margin-left:auto" class="small">Local POC • No auth</div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:600">Run Command</div>
          <div class="small">Allowed: ls, pwd, whoami, date, uptime, df, free, echo, ps, id</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="quick" style="flex:0 0 180px;padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
            <option value="">— quick command —</option>
            <option>whoami</option>
            <option>pwd</option>
            <option>ls -la</option>
            <option>uptime</option>
            <option>df -h</option>
            <option>free -m</option>
          </select>
          <input id="cmd" type="text" placeholder="enter command" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
          <button id="run" class="primary">Run</button>
        </div>
        <div style="margin-top:8px">
          <div class="cmd-out" id="cmdout">No command run yet.</div>
        </div>
      </div>

      <div class="footer">
        <div class="small">HuggingFace: <span id="hf">not configured</span></div>
        <div class="small">vnc: <span id="vncport">8080</span></div>
      </div>
    </aside>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const summ = document.getElementById('summarize');
    const status = document.getElementById('status');
    const hfEl = document.getElementById('hf');
    const quick = document.getElementById('quick');
    const cmdIn = document.getElementById('cmd');
    const runBtn = document.getElementById('run');
    const cmdout = document.getElementById('cmdout');

    async function refreshStatus(){
      try {
        const r = await fetch('/status');
        if (r.ok) {
          const j = await r.json();
          status.innerText = j.status || 'online';
          hfEl.innerText = j.profile && j.profile.hf ? 'configured' : 'not configured';
        } else {
          status.innerText = 'offline';
        }
      } catch(e){
        status.innerText = 'offline';
      }
    }
    refreshStatus();

    function append(role, text){
      const div = document.createElement('div');
      div.className = 'msg ' + (role==='user'?'user':'ai');
      const b = document.createElement('div'); b.className='bubble'; b.innerText = text;
      div.appendChild(b);
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    send.onclick = async () => {
      const txt = input.value.trim(); if(!txt) return;
      append('user', txt); input.value='';
      append('ai','…thinking…');
      try{
        const res = await fetch('/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({messages:[{role:'user',content:txt}]})});
        const j = await res.json();
        // remove the thinking bubble
        const nodes = chatEl.querySelectorAll('.msg.ai'); const last = nodes[nodes.length-1]; if(last) last.remove();
        append('ai', j.reply || JSON.stringify(j));
      }catch(e){
        append('ai','Error: ' + e.toString());
      }
    };

    summ.onclick = async () => {
      const txt = input.value.trim(); if(!txt) return;
      append('user', txt);
      append('ai','…summarizing…');
      try{
        const res = await fetch('/summarize',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({text:txt})});
        const j = await res.json();
        const nodes = chatEl.querySelectorAll('.msg.ai'); const last = nodes[nodes.length-1]; if(last) last.remove();
        append('ai', j.summary || j.error || JSON.stringify(j));
      }catch(e){
        append('ai','Error: '+e.toString())
      }
    };

    quick.onchange = ()=>{
      if(quick.value) cmdIn.value = quick.value;
    };

    runBtn.onclick = async ()=>{
      const cmd = cmdIn.value.trim(); if(!cmd) { cmdout.innerText = 'Enter a command or choose a quick command.'; return; }
      cmdout.innerText = 'Running…';
      try{
        const r = await fetch('/exec', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({cmd})});
        if(!r.ok){
          const err = await r.json().catch(()=>null);
          cmdout.innerText = `Error: ${r.status} ${err ? JSON.stringify(err) : ''}`;
          return;
        }
        const j = await r.json();
        let out = '';
        out += `> ${j.cmd}\n\n`;
        out += `exit=${j.returncode}\n\n`;
        out += `stdout:\n${j.stdout || '(none)'}\n\n`;
        if(j.stderr) out += `stderr:\n${j.stderr}\n\n`;
        cmdout.innerText = out;
        // also append to chat for context
        append('user', `Run: ${cmd}`);
        append('ai', `Command output (see right panel).`);
      }catch(e){
        cmdout.innerText = 'Error: '+e.toString();
      }
    };

    // Enter to send
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send.click(); } });
  </script>
</body>
</html>
